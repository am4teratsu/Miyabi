<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Miyabi | Gestión de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

	<nav class="navbar navbar-dark bg-dark shadow-sm mb-4">
	    <div class="container">
	        <a th:href="@{/admin/dashboard}" class="navbar-brand fw-bold text-decoration-none text-white">
	            <i class="bi bi-building"></i> MIYABI Admin
	        </a>
	        
	        <div class="d-flex align-items-center">
	            <a th:href="@{/admin/dashboard}" class="btn btn-outline-light btn-sm me-2">
	                <i class="bi bi-speedometer2"></i> Dashboard
	            </a>
	            <a th:href="@{/admin/rooms}" class="btn btn-outline-light btn-sm me-2">
	                <i class="bi bi-door-open"></i> Habitaciones
	            </a>
	            <a th:href="@{/admin/room-types}" class="btn btn-outline-light btn-sm me-2">
	                <i class="bi bi-tags"></i> Tarifas
	            </a>
	            <a th:href="@{/admin/users}" class="btn btn-outline-light btn-sm me-2">
	                <i class="bi bi-people"></i> Personal
	            </a>
	            
	            <div class="vr mx-2 text-white opacity-50"></div>
	            
	            <a href="/" class="btn btn-sm btn-light">
	                <i class="bi bi-box-arrow-up-right"></i> Ver Web
	            </a>
	        </div>
	    </div>
	</nav>

    <div class="container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-people-fill me-2"></i> Personal del Hotel</h5>
                <button class="btn btn-primary" onclick="prepareNewUser()">
                    <i class="bi bi-person-plus"></i> Nuevo Usuario
                </button>
            </div>
            <div class="card-body">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Email / Usuario</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="u : ${listUsers}">
                            <td>
                                <strong th:text="${u.names} + ' ' + ${u.surnames}">Nombre</strong>
                            </td>
                            <td th:text="${u.email}">admin@hotel.com</td>
                            <td>
                                <span class="badge bg-dark" th:text="${u.rol?.nameRol}">Rol</span>
                            </td>
                            <td>
                                <span th:class="${u.state == 1 ? 'badge bg-success' : 'badge bg-danger'}">
                                    [[${u.state == 1 ? 'Activo' : 'Inactivo'}]]
                                </span>
                            </td>
                            <td class="text-end">
								<button class="btn btn-sm btn-outline-primary me-1" 
								        th:onclick="'editUser(' + ${u.idUsuario} + ')'">
								    <i class="bi bi-pencil"></i>
								</button>
                                <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteUser(' + ${u.idUsuario} + ')'">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalUser" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalTitle">Registrar Nuevo Personal</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formUser">
                    <div class="modal-body row g-3">
                        <input type="hidden" id="uId">
                        
                        <div class="col-md-6">
                            <label class="form-label">Nombres</label>
                            <input type="text" class="form-control" id="uNames" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellidos</label>
                            <input type="text" class="form-control" id="uSurnames" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Email (Usuario)</label>
                            <input type="email" class="form-control" id="uEmail" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="uPassword" placeholder="Dejar en blanco para no cambiar">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Asignar Rol</label>
                            <select class="form-select" id="uRol" required>
                                <option value="1">Administrator</option>
                                <option value="2">Receptionist</option>
                                <option value="3">Client</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="uState">
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary" id="btnSave">Guardar Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const modalElement = new bootstrap.Modal(document.getElementById('modalUser'));
        const formUser = document.getElementById('formUser');

        // Función para limpiar el modal al crear uno nuevo
        function prepareNewUser() {
            document.getElementById('modalTitle').innerText = "Registrar Nuevo Personal";
            formUser.reset();
            document.getElementById('uId').value = "";
            document.getElementById('uPassword').required = true;
            modalElement.show();
        }

		function editUser(id) {
		    document.getElementById('modalTitle').innerText = 'Editar Personal';
		    
		    // Pedimos los datos actuales del usuario al servidor
		    fetch('/api/users/' + id)
		        .then(response => response.json())
		        .then(data => {
		            // Rellenamos el modal con lo que nos responda el "data"
		            document.getElementById('uId').value = data.idUsuario;
		            document.getElementById('uNames').value = data.names;
		            document.getElementById('uSurnames').value = data.surnames;
		            document.getElementById('uEmail').value = data.email;
		            document.getElementById('uRol').value = data.rol?.idRol; // El ID del rol
		            document.getElementById('uState').value = data.state;
		            
		            // La contraseña no se carga por seguridad, se deja vacía
		            document.getElementById('uPassword').value = "";
		            document.getElementById('uPassword').required = false;
		            
		            modalElement.show();
		        });
		}

        formUser.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('uId').value;
            
            const userData = {
                names: document.getElementById('uNames').value,
                surnames: document.getElementById('uSurnames').value,
                email: document.getElementById('uEmail').value,
                state: document.getElementById('uState').value,
                rol: { idRol: document.getElementById('uRol').value }
            };

            // Solo incluimos la contraseña si se escribió algo (para no sobreescribirla con vacío al editar)
            const pass = document.getElementById('uPassword').value;
            if (pass) userData.password = pass;

            // Decidimos si es POST o PUT
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/users/${id}` : '/api/users';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            }).then(response => {
                if(response.ok) location.reload();
                else alert("Error al procesar la operación. Revisa los datos.");
            });
        });

        function deleteUser(id) {
            if(confirm('¿Deseas dar de baja definitivamente a este usuario?')) {
                fetch('/api/users/' + id, { method: 'DELETE' })
                .then(() => location.reload());
            }
        }
    </script>
</body>
</html>